<!--We put the import statements at the top.-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">


<!--********* Non UI imports-->
<!--Used to query the dict api.-->
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<!--*************UI Related imports-->
<!--We're using the drawer layout, so: -->
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<!--Main display area is composed of a header, so: -->
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<!--TOKNOW what's this for? Perhaps because we use some has-scrolling-region parameter below?-->
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<!--We've got a toolbar in the header, where the title and the combo box reside.-->
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<!--We've got a combobox in the toolbar.-->
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<!--We display dict entries!
Getting "lazy-import" working seems quite involved. So "import" for now.-->
<link rel="import" href="dict-entry-view.html">


<dom-module id="dict-ui">
  <template>
    <!--It is convention to place the style at the top. We don't seem to need "shared-style"s here.-->
    <style>
      :host {
        /*TOKNOW: I have no idea what :host is.*/

        /*This is the color used in the page header - see the app-header block below.*/
        --app-primary-color: #f4dc28;
        --app-secondary-color: black;
        display: block;
      }

      /*********************We use the drawer layout (see below). This is its style.*/
      app-drawer-layout:not([narrow]) [drawer-toggle] {
        /* Something to do with the drawer.
      TOKNOW: What is the not([narrow]) bit above?.*/
        display: none;
      }

      .drawer-list {
        margin: 0 20px;
      }

      /*This is what each item in the drawer to the left will look like.*/
      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      /*This is what the selected item in the drawer to the left will look like.*/
      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      /*********************The main part of our app has a header. This is its style*/
      app-header {
        color: black;
        background-color: var(--app-primary-color);
      }
    </style>
    <app-drawer-layout fullbleed="">

      <!-- Drawer content
      Depending on the screen size, it will need to be "pulled out" by the user. Neat!
      * TODO: The drawer will eventually index the definitions we will show in the result, helping the user navigate.
      * TODO: There might also be a link to setting the user preferences and the like.
      -->
      <app-drawer id="drawer" slot="drawer">
        <app-toolbar>Result index</app-toolbar>
      </app-drawer>

      <!-- Main content
      Now, here we have everything apart from the drawer. It has two parts:
      * the header,
      * and the content page.
      TOKNOW: What does has-scrolling-region="" mean?
      -->
      <app-header-layout has-scrolling-region="">
        <app-header slot="header" condenses="" reveals="" effects="waterfall">
          <app-toolbar>
            <!--
            This is the search box!
            * The value typed by the user is bound to the query property, which is also used in the iron-ajax element which makes a REST API call to our dictionary database.
            * The combo-box items are bound to the headwords variable. [[]] means that the binding is 1-way "host to target",
              where dict-ui is the host, and vaadin-combo-box is the "target".
            -->
            <!--More comments about how the headwords are populated are provided in the properties function.
            TODO: Listen to changes.
            -->
            <vaadin-combo-box
                    id="queryBox" label="Query"
                    filter="{{query}}"  filtered-items="[[headwords]]" on-filter-changed="_queryChanged"
                    on-value-changed="_headwordSelectionHandler"
                    loading="[[headwordQueryAppWorking]]"
                    allow-custom-value></vaadin-combo-box>

            <!--Iron AJAX! Here is where we get headwords starting with a given prefix.
            http://vedavaapi.org:5984/dict_entries/_design/index_headwords/_view/index_headwords?limit=500&reduce=false&start_key="ast"

            20170804- With params='{"limit":500, "start_key":"[[query]]", "reduce" : False}', I ran into this problem: https://stackoverflow.com/questions/34164649/polymer-iron-ajax-element-params-with-databinding-is-splitting-the-parameter-int . Hence doing a workaround.

            Not using "auto" mostly to work around the above.
            -->
            <iron-ajax
                    id="headwordQueryApp"
                    url="http://vedavaapi.org:5984/dict_entries/_design/index_headwords/_view/index_headwords"
                    params='{"start_key":"[[query]]"}'
                    loading={{headwordQueryAppWorking}}
                    handle-as="json"
                    on-response="_handleHeadwordResponse"
                    debounce-duration="300"></iron-ajax>


            <!--A title shown in the middle of the header. TODO: Make this appear to the right instead?-->
            <div main-title="" spacer="">Dict UI</div>
          </app-toolbar>
        </app-header>

        <!--The main part of the app, where dict definitions are shown.
        -->
        <dict-entry-view name="dict-entry-view"></dict-entry-view>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
      class DictUi extends Polymer.Element {
          static get is() { return 'dict-ui'; }

          static get properties() {
              return {
                  // This is bound to the combo-box in the header. As a user types a character, nearby headwords are set in this array.
                  headwords: Array,
                  headwordMap: Object,
                  query: String,
                  headwordQueryAppWorking: Boolean
              };
          }

          // This is called when the queryBox value is changed. headwordQueryApp is used to get headwords starting with the query.
          _queryChanged(e) {
              var query = e.detail.value;
              if (query == "") {
                  console.log("Ignoring empty query");
              } else {
                  // Lets use the headwordQueryApp component to make the AJAX call.
                  var headwordQueryApp = this.$.headwordQueryApp;
                  // Why are we not doing the databinding more imperatively? See comment above the iron-ajax element.
                  headwordQueryApp.params = {
                      "limit":500,
                      "start_key": `"${query}"`,
                      "reduce" : "False"
                  }
                  headwordQueryApp.generateRequest();
              }
          }

          // This is called once the AJAX call by headwordQueryApp has finished. Auto-suggestions in the query box is changed.
          _handleHeadwordResponse(e) {
            var nextHeadwordRows = e.detail.response.rows;
            var query = this.get("query");
            var headwordsList = nextHeadwordRows.filter(function (row) {
                  return row.key.startsWith(query);
            }).map(function (row) {
                return row.key;
            });
            this.set("headwords", Array.from(new Set(headwordsList)));
            console.log(e.detail.response);
          }

          _headwordSelectionHandler(e) {

          }
      }

      window.customElements.define(DictUi.is, DictUi);
  </script>
</dom-module>
